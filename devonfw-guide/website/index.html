<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>devonfw guide</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="//fonts.googleapis.com/css?family=Ubuntu"
    />

    <!-- Style for the header/navbar -->
    <link
      rel="stylesheet"
      type="text/css"
      href="components/header/header.css"
    />

    <!-- Script for the header/navbar -->
    <script src="components/header/header.js"></script>

    <!-- Style fort the cards -->
    <link rel="stylesheet" type="text/css" href="pages/cards/cards.css" />

    <!-- Script for the cards -->
    <script src="pages/cards/cards.js"></script>

    <script
      src="https://code.jquery.com/jquery-3.4.1.min.js"
      integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
      crossorigin="anonymous"
    ></script>
    <script src="https://unpkg.com/lunr/lunr.js"></script>

    <!-- General styles -->
    <link rel="stylesheet" type="text/css" href="shared/styles/styles.css" />
  </head>

  <body>
    <div class="main-content">
      <div id="website-navbar" class="website-navbar"></div>
      <div id="website-content" class="website-content">
        <div id="logo-page" class="logo-page"></div>
      </div>
    </div>

    <script>
      const LAYOUT_URL = 'layout/layout.html';
      const NAVBAR_DEST = '#website-navbar';

      const CARDS_HTML_UL = `${LAYOUT_URL} #content .sect1`;
      const CARDS_DEST = '#logo-page';

      $(window).on('load', function() {
        HeaderModule.loadNavbar(NAVBAR_DEST, getSearchBar);

        loadCards(CARDS_HTML_UL, CARDS_DEST, editSrc);
      });

      function editSrc(searchValue, replaceValue) {
        let searchVal =
          searchValue ||
          'C:/Proyectos/devon-docgen-projects/devonfw-guide-fork-faster/devonfw-guide/target/generated-docs/';
        let replaceVal = replaceValue || '../';

        $('img').each(function() {
          $(this).attr(
            'src',
            $(this)
              .attr('src')
              .replace(searchVal, replaceVal),
          );
        });
      }

      function query() {
        $.getJSON('docs-json.json', function(docsJson) {
          docs = docsJson;

          return ((docs) => {
            $.getJSON('index.json', function(idxJson) {
              let idx = lunr.Index.load(idxJson);
              let query = document.getElementById('search-field').value;
              let queryRes = idx.search(query);

              const findById = (id, objects) => {
                const obj = objects.find((obj) => '' + obj.id == '' + id);
                console.log(obj);
                return obj.title;
              };

              let results = '';
              for (let i = 0; i < queryRes.length; i++) {
                res = queryRes[i];
                if (i > 5) break;
                results += `
                  <div>
                    <div class="sr-title">
                      ${findById(res.ref, docs)}
                    </div>
                    <div class="sr-content">
                      ${res.ref}
                    </div>
                  </div>`;
              }

              $('#search-results').html(results);
              $('#search-results').removeClass('hidden');
              $('.sr-content').each(function(item) {
                $(this).click(function() {
                  location.href =
                    'pages/docs/page-docs.html' +
                    '?q=' +
                    $(this)
                      .text()
                      .trim()
                      .replace('./devonfw-guide/', '../').replace(/\.asciidoc$/, '.html');
                });
              });
            });
          })(docs);
        });
      }

      function getSearchBar() {
        const searchBar = `
        <li>
          <div class="search-bar">
            <input id="search-field" type="text" placeholder="Search by keyword(s)..."/>
            <button onclick="query()">Search</button>
            <div class="search-bar-results hidden" id="search-results">
            </div>
          </div>
        </li>`;

        HeaderModule.appendEnd(NAVBAR_DEST, searchBar);
      }
    </script>
  </body>
</html>
