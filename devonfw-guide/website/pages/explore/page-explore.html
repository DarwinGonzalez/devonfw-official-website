<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />

    <link
      rel="stylesheet"
      type="text/css"
      href="//fonts.googleapis.com/css?family=Ubuntu"
    />

    <!-- Style for the header/navbar -->
    <link
      rel="stylesheet"
      type="text/css"
      href="../../components/header/header.css"
    />

    <!-- Script for the header/navbar -->
    <script src="../../components/header/header.js"></script>

    <!-- Style fort the resources -->
    <link rel="stylesheet" type="text/css" href="explore.css" />

    <!-- Script for the resources -->
    <script src="explore.js"></script>

    <!-- Script for the community -->
    <script src="../../shared/utils.js"></script>

    <!-- JQuery -->
    <script
      src="https://code.jquery.com/jquery-3.4.1.min.js"
      integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
      crossorigin="anonymous"
    ></script>

    <!-- Lunr -->
    <script src="https://unpkg.com/lunr/lunr.js"></script>

    <!-- General styles -->
    <link
      rel="stylesheet"
      type="text/css"
      href="../../shared/styles/styles.css"
    />

    <title>Explore page</title>
  </head>
  <body>
    <div id="website-navbar" class="website-navbar"></div>
    <div id="explore-page" class="explore-page "></div>
    <div class="dir-component">
      <div class="dir-tree">
        <div class="dir-column">
          <ul class="bullet-folder-closed column-1"></ul>
        </div>
      </div>
      <div class="dir-tree-detail">
        <h2 class="details-first-title"></h2>
        <h2 class="details-title"></h2>
        <p class="details-content"></p>
      </div>
    </div>
    <script>
      const EXPLORE_DEST = '#explore-page';
      const NAVBAR_DEST = '#website-navbar';

      let searchData = { index: null, documents: null };
      UtilsModule.loadIndex(searchData);

      $(window).on('load', function() {
        const queryFun = () => {
          HeaderModule.queryFunction(searchData);
        };

        HeaderModule.loadNavbar(NAVBAR_DEST, () => {
          HeaderModule.searchOnClick(queryFun);
        });

        ExploreModule.loadExplorePage(EXPLORE_DEST, () => {
          UtilsModule.editSrc(undefined, '../../');

          getDirs('./dir-content', 'entry-point.html', 0);
        });
      });

      function getDirs(dir, entryPoint, lvl) {
        let aux = $("<div id='aux'></div>");

        aux.load(`${dir}/${entryPoint} #content`, function() {
          aux.find('.links-to-files a').each(function(index, el) {
            let href = $(el).attr('href');
            let aux2 = $("<div id='aux2'></div>");

            aux2.load(`${dir}/${href} #content`, getDirInfo(aux2, el, lvl));
          });
        });
      }

      function getDirInfo(aux2, el, lvl) {
        return () => {
          let dir = aux2.find('.directory');
          let links = aux2.find('.links-to-files');
          let title = dir.find('h2').text();
          let text = getText(dir);
          let listItem = getLiDir(title, el, lvl + 1);

          if (!links.length) {
            listItem = getLiFile(title, text, lvl + 1);
          }

          $('.column-' + (lvl + 1)).append(listItem);
        };
      }

      function getText(dir) {
        return dir
          .find('p')
          .map((index, el) => $(el).text() + '<br/>')
          .get()
          .join('');
      }

      function getDetails(title, content) {
        $('.dir-component .details-title').html(title);
        $('.dir-component .details-content').html(content);
        $('.dir-component .details-first-title').html('More info ->');
      }

      function getLiDir(text, el, lvlDest) {
        function clickHandler() {
          $(this)
            .addClass('bullet-folder-open')
            .siblings()
            .removeClass('bullet-folder-open');
          clearDir(lvlDest + 1);
          createNewColumn();

          slideCols(lvlDest + 1, 3);
          getDirs('./dir-content', $(el).attr('href'), lvlDest);
        }

        let listItem = $(`<li>${text}</li>`).click(clickHandler);
        return listItem;
      }

      function getLiFile(title, content, lvlDest) {
        function clickHandler() {
          getDetails(title, content);
        }

        let listItem = $(`<li class="bullet-file">${title}</li>`).click(
          clickHandler,
        );
        return listItem;
      }

      function createNewColumn() {
        let howManyCols = $('.dir-tree .dir-column').length;
        $('.dir-tree').append(
          `
              <div class="dir-column">
                <ul class="bullet-folder-closed column-${howManyCols + 1}"></ul>
              </div>
            `,
        );
      }

      function clearDir(fromLvl = 1) {
        let howManyCols = $('[class*="column-"]').length;
        for (let i = fromLvl; i <= howManyCols; i++) {
          $(`.column-${i}`)
            .parent()
            .remove();
        }

        $('.dir-component .details-title').empty();
        $('.dir-component .details-content').empty();
        $('.dir-component .details-first-title').empty();
      }

      function slideCols(pivot, maxVisible) {
        $('.dir-column').each((index, elem) => {
          let hiddenBefore = 3;
          if (index < pivot - hiddenBefore || index > pivot) {
            $(elem).addClass('hidden');
          } else {
            $(elem).removeClass('hidden');
            let folder = $(elem).find('.bullet-folder-open');
            let text = folder.text();
            let splitted = text.split('/');
            let isDotted = splitted.length >= 2 && splitted[0] === '..';

            if (
              index == pivot - hiddenBefore &&
              index + hiddenBefore > maxVisible
            ) {
              if (!isDotted) {
                text = '../' + text;
              }

              $(elem);
              folder
                .text(text)
                .siblings()
                .remove();
            } else {
              if (isDotted) {
                $(elem);
                folder.text(splitted[1]);
              }
            }
          }
        });
      }
    </script>
  </body>
</html>
